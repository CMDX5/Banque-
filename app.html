/* =========================================================
   INITIALISATION FIREBASE
========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// Configuration Firebase
import { firebaseConfig } from "./firebase-config.js";

// Initialisation Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);


/* =========================================================
   ELEMENTS DU DOM
========================================================= */
const loginPanel = document.getElementById("login-panel");
const registerPanel = document.getElementById("register-panel");
const dashboard = document.getElementById("dashboard");

const logoutBtn = document.getElementById("logoutBtn");

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");

const regEmail = document.getElementById("reg-email");
const regPassword = document.getElementById("reg-password");

const loginMessage = document.getElementById("login-message");
const registerMessage = document.getElementById("register-message");

const passwordToggleBtn = document.getElementById("passwordToggle");


/* =========================================================
   AFFICHAGE / MASQUER LES PANNEAUX
========================================================= */
function showLogin() {
  loginPanel.style.display = "block";
  registerPanel.style.display = "none";
}

function showRegister() {
  loginPanel.style.display = "none";
  registerPanel.style.display = "block";
}

window.showLogin = showLogin;
window.showRegister = showRegister;


/* =========================================================
   CREATION DE COMPTE
========================================================= */
async function register() {
  registerMessage.textContent = "";

  try {
    const userCredential = await createUserWithEmailAndPassword(
      auth,
      regEmail.value,
      regPassword.value
    );

    const user = userCredential.user;

    await setDoc(doc(db, "users", user.uid), {
      email: user.email,
      balance: 0,
      kycStatus: "none"
    });

    registerMessage.style.color = "#4ade80";
    registerMessage.textContent = "Compte créé avec succès !";

    setTimeout(showLogin, 900);

  } catch (error) {
    registerMessage.style.color = "#f87171";
    registerMessage.textContent = error.message;
  }
}

window.register = register;


/* =========================================================
   CONNEXION
========================================================= */
async function login() {
  loginMessage.textContent = "";

  try {
    const userCredential = await signInWithEmailAndPassword(
      auth,
      emailInput.value,
      passwordInput.value
    );

    loginMessage.style.color = "#4ade80";
    loginMessage.textContent = "Connexion réussie !";

    setTimeout(() => {
      loginPanel.style.display = "none";
      dashboard.style.display = "block";
    }, 600);

  } catch (error) {
    loginMessage.style.color = "#f87171";
    loginMessage.textContent = error.message;
  }
}

window.login = login;


/* =========================================================
   DECONNEXION
========================================================= */
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  dashboard.style.display = "none";
  loginPanel.style.display = "block";
});


/* =========================================================
   TOGGLE PASSWORD (AFFICHER / MASQUER)
========================================================= */
function togglePassword() {
  const input = document.getElementById("password");
  const btn = document.getElementById("passwordToggle");

  if (!input || !btn) return;

  const isHidden = input.type === "password";

  input.type = isHidden ? "text" : "password";
  btn.textContent = isHidden ? "Masquer" : "Afficher";
}

window.togglePassword = togglePassword;


/* =========================================================
   SURVEILLANCE DE L’ETAT D’AUTHENTIFICATION
========================================================= */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    logoutBtn.style.display = "inline-block";
  } else {
    logoutBtn.style.display = "none";
  }
});


/* =========================================================
   DASHBOARD : LECTURE DES DONNÉES
========================================================= */
async function loadUserData(uid) {
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();
    document.getElementById("userBalance").textContent =
      data.balance + " XAF";

    document.getElementById("kycStatus").textContent =
      data.kycStatus || "none";
  }
}

auth.onAuthStateChanged(async (user) => {
  if (user) {
    await loadUserData(user.uid);
  }
});
